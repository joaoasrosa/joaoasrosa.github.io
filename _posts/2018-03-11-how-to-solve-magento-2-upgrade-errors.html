---
layout: post
title: How to solve Magento 2 upgrade errors
date: 2018-03-11 12:54:21.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Continuous Deployment
- Continuous Integration
- Magento 2
- OSS
tags:
- Linux
- Magento2
meta:
  _wpcom_is_markdown: '1'
  _rest_api_published: '1'
  _rest_api_client_id: "-1"
  _publicize_job_id: '15609200966'
  timeline_notification: '1520769261'
  publicize_google_plus_url: https://plus.google.com/105879670784970671735/posts/8btbv89ZeT7
  _publicize_done_15567246: '1'
  _wpas_done_15420870: '1'
  _publicize_done_external: a:1:{s:7:"twitter";a:1:{i:15487188;s:56:"https://twitter.com/joaoasrosa/status/972802946042867713";}}
  _publicize_done_15638091: '1'
  _wpas_done_15487188: '1'
  publicize_twitter_user: joaoasrosa
  publicize_linkedin_url: https://www.linkedin.com/updates?discuss=&scope=27794317&stype=M&topic=6378568641138421760&type=U&a=71My
  _publicize_done_15638097: '1'
  _wpas_done_15487191: '1'
  _oembed_a2fb2f0e69076690c87567fab3364dd7: '<div class="embed-twitter"><blockquote
    class="twitter-tweet" data-width="500" data-dnt="true"><p lang="en" dir="ltr">If
    you want to tweet or blog about how serverless actually runs on servers, let me
    save you some time: Nobody thinks that serverless doesn&#39;t run on servers.
    Nobody. You&#39;re just taking cheap shots at a catchy name.</p>&mdash; Mathias
    Verraes (@mathiasverraes) <a href="https://twitter.com/mathiasverraes/status/995317295072382976?ref_src=twsrc%5Etfw">May
    12, 2018</a></blockquote><script async src="https://platform.twitter.com/widgets.js"
    charset="utf-8"></script></div>'
  _oembed_time_a2fb2f0e69076690c87567fab3364dd7: '1526479963'
author:
  login: joaoasrosa
  email: joaoasrosa@gmail.com
  display_name: João Rosa
  first_name: ''
  last_name: ''
permalink: "/2018/03/11/how-to-solve-magento-2-upgrade-errors/"
---
<p>Magento 2 is the leading Open Source Software for e-commerce, with a vibrant community and proper product documentation.</p>
<p>The development team releases bug fixes and new features in a regular cadence, given support to security threats, market trends, amongst others.</p>
<h2>Environment</h2>
<p>The environment is <a href="https://anotherlookontech.wordpress.com/2018/01/14/migrate-magento-from-on-premises-to-the-cloud/" rel="noopener">deployed in AWS</a>, using an immutable infrastructure. It allows us to deploy several development/testing environments where we can develop the scripts to automate the upgrade process for our CI/CD pipeline. Also, it is our workbench for testing UI changes, new plugins, amongst others.</p>
<h2>Upgrading</h2>
<p>However, trying to upgrade to the latest version (at the moment of writing this post is 2.2.3), using the <a href="http://devdocs.magento.com/guides/v2.2/comp-mgr/cli/cli-upgrade.html" rel="noopener">official documentation</a>, we receive the following error:</p>
<p>[caption id="attachment_1858" align="aligncenter" width="982"]<img class="size-full wp-image-1858 aligncenter" src="{{ site.baseurl }}/assets/magento2_upgrade_004.png" alt="magento2_upgrade_004" width="982" height="618" /> Magento 2 upgrade command - failed to open stream error[/caption]</p>
<p>This is annoying. So far, we had reliable platform upgrades. Using my developer hat, we followed the error. A file was missing in the <code>magento 2 installation path\setup\</code> folder.</p>
<p>Doing a quick search with the <code>ls</code> command, we had the folder structure:</p>
<p>[caption id="attachment_1857" align="aligncenter" width="982"]<img class="size-full wp-image-1857 aligncenter" src="{{ site.baseurl }}/assets/magento2_upgrade_003.png" alt="magento2_upgrade_003" width="982" height="674" /> Magento 2 root folder - after the ls command[/caption]</p>
<p>The code never lies. The <code>setup</code>/ folder doesn't exist. It intrigued us, getting us to investigate why the folder wasn't there. We verified:</p>
<ul>
<li>The <a href="https://github.com/magento/magento2/tree/2.2" rel="noopener">official GitHub repo</a>. The <code>setup/</code> folder exists, and it has content</li>
<li>Download the official <a href="https://magento.com/tech-resources/download" rel="noopener">Magento 2 Full Release</a>, inspecting the contents. Again, the <code>setup/</code> folder exists, and it has content</li>
<li>Deploy a new AWS development environment with the current infrastructure, inspecting the folder structure. The <code>setup/</code> folder <strong>exists</strong> in the current installation</li>
</ul>
<p>[caption id="attachment_1855" align="aligncenter" width="980"]<img class="size-full wp-image-1855 aligncenter" src="{{ site.baseurl }}/assets/magento2_upgrade_001.png" alt="magento2_upgrade_001" width="980" height="608" /> Magento 2 root folder - current installation[/caption]</p>
<p>Given the information from our investigation, it seemed to point out to the PHP Composer, which doesn't deploy the <code>setup/</code> folder during the upgrade process. To prove it, we tried to upgrade the environment again, using the same commands:</p>
<p>[caption id="attachment_1856" align="aligncenter" width="976"]<img class="size-full wp-image-1856 aligncenter" src="{{ site.baseurl }}/assets/magento2_upgrade_002.png" alt="magento2_upgrade_002" width="976" height="674" /> Magento 2 composer - update command[/caption]</p>
<p>And we were able to reproduce the initial error. At least it is reproducible and supports our theory. :)</p>
<h2>The (temporary) solution</h2>
<p>Since the PHP Composer package should contain (apart from the metadata file) the same files as  the downloadable Magento 2 installation package, we've tried to:</p>
<ul>
<li>Follow the upgrade steps from the official guide <strong>until step 6</strong> (<em>Update the database schema and data</em>)</li>
<li>Download the Magento 2 installation package</li>
<li>Extract the <code>setup/</code> folder to the Magento 2 installation folder</li>
<li>Resume the Magento 2 upgrade process</li>
</ul>
<p>And voilá, it finished the Magento 2 upgrade to the version 2.2.3. Happy days, we can do our testing on the new version of the shop, before promoting it to production.</p>
<p>This error had been reported to the Magento development team, however, they can't reproduce it. Nevertheless, we can use this workaround to upgrade our (your) shop.</p>
