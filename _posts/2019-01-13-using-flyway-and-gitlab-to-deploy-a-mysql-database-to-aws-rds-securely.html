---
layout: post
title: Using Flyway and GitLab to deploy a MySQL database to AWS RDS securely
date: 2019-01-13 14:37:39.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Cloud Computing
- Continuous Deployment
- Continuous Integration
- OSS
tags:
- AWS
- CI/CD
- Flyway
- GitLab
- MySQL
- RDS
meta:
  _wpcom_is_markdown: '1'
  _publicize_done_external: a:1:{s:7:"twitter";a:1:{i:15487188;s:57:"https://twitter.com/joaoasrosa/status/1084444405623386117";}}
  timeline_notification: '1547386664'
  _publicize_job_id: '26486211107'
  publicize_google_plus_url: https://plus.google.com/105879670784970671735/posts/gYAcHE314uy
  _publicize_done_15567246: '1'
  _wpas_done_15420870: '1'
  _publicize_done_15638091: '1'
  _wpas_done_15487188: '1'
  publicize_twitter_user: joaoasrosa
  publicize_linkedin_url: www.linkedin.com/updates?topic=6490210098873409536
  _publicize_done_15638097: '1'
  _wpas_done_15487191: '1'
author:
  login: joaoasrosa
  email: joaoasrosa@gmail.com
  display_name: João Rosa
  first_name: ''
  last_name: ''
permalink: "/2019/01/13/using-flyway-and-gitlab-to-deploy-a-mysql-database-to-aws-rds-securely/"
---
<p><!-- wp:paragraph --></p>
<p>One of my passions is to be a trainer. Sharing knowledge, meeting new people, be continuously challenged, it fuels my brain, and I'm always learning something new. I'm creating a new training for software development teams, and one of the components is a MySQL database. Also, I'm using a public cloud provider (in this case AWS), and Xebia provides accounts to cover training, workshops and our own experiments.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>All the application and infrastructure definition (code) is in GitLab. It gives a central place with source code and CI/CD. And I can automate everything! :) The stack is not up and running 24/7, and I do not like to repeat myself executing the scripts manually (in the end <a href="https://www.youtube.com/watch?v=L3wKzyIN1yk">I'm only human</a>, and I will fail in the script execution). Thus, I have a pipeline to validate and lint the CloudFormation templates, build the app and run the tests, deploy the CloudFormation template, deploy the database and finally deploy the app. Pretty standard nowadays.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>To deploy the database, I decided to use <a href="https://flywaydb.org">Flyway</a>. It offers supports to different database technologies, and the Community version (free) has an interesting range of features, the features that I need to deploy the database. It also packs the Flyway CLI in a <a href="https://hub.docker.com/r/boxfuse/flyway/">Docker image</a>, which is precisely what I need for my GitLab pipeline.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Great! I can use the Docker image in my pipeline. My pipeline is multi-stage, and in each stage, I use different Docker images, with the tools needed for that particular stage. Separation of concerns, right?</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>My <code>.gitlab-ci.yml</code> looks like this (omitting parts of the script):</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code>stages:
  - validate
  - build
  - deploy
  - deploy-database

validate:
  image: validate-image
  stage: validate
  ...

build:
  image: build-image
  stage: build
  ...

deploy:
  image: deploy-image
  stage: deploy
  ...

deploy-database:
  image: boxfuse/flyway:5.2.4-alpine
  stage: deploy-database
  script:
    - export FLYWAY_PASSWORD=$DB_PASSWORD
    - flyway -configFiles=src/database/conf/flyway.conf info
    - flyway -configFiles=src/database/conf/flyway.conf migrate
    - flyway -configFiles=src/database/conf/flyway.conf info</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:html --></p>
<p>If we take a close look at the <code>deploy-database</code> stage, it:</p>
<ol>
<li>Sets the database password from a secure environment variable</li>
<li>Displays the information from the current database migration</li>
<li>Execute the migrations</li>
<li>Displays the information from the current database migration</li>
</ol>
<p><!-- /wp:html --></p>
<p><!-- wp:paragraph --></p>
<p>Let's run it!</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":1883} --></p>
<figure class="wp-block-image"><img src="{{ site.baseurl }}/assets/screenshot-2019-01-13-at-11.38.24.jpg" alt="" class="wp-image-1883" /><br />
<figcaption>Using the Flyway image to deploy the database</figcaption>
</figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>Errrggghhh... It fails. Taking a look into the <a href="https://github.com/flyway/flyway-docker/blob/bf62140795fcdcf8e16bc7038ac74eb88b66985c/alpine/Dockerfile#L14">Dockerfile</a>, I discovered why. The <code>entrypoint</code> is to the Flyway CLI tool, and it expects Flyway commands. Well, a way to bypass it is to create a new Docker image based on the Flyway image and set the <code>entrypoint</code> to <code>/usr/bin/env</code> for example. The Dockerfile:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code>FROM boxfuse/flyway:5.2.4-alpine
LABEL maintainers="João Rosa &lt;https://joaorosa.io&gt;"

ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

ENTRYPOINT ["/usr/bin/env"]</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:paragraph --></p>
<p>Updating the stage <code>deploy-database</code> in <code>.gitlab-ci.yml</code> to use the new Docker image, and run it we have...</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":1886} --></p>
<figure class="wp-block-image"><img src="{{ site.baseurl }}/assets/screenshot-2019-01-13-at-11.54.10.jpg" alt="" class="wp-image-1886" /><br />
<figcaption>Successful run of the database deployment! Or not...</figcaption>
</figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>The connection is <strong>not secure</strong>! That is not acceptable. <br />Looking to the <a href="https://dev.mysql.com/doc/refman/5.7/en/encrypted-connections.html">MySQL documentation</a>, it is possible to explicitly indicate to use SSL in the connection. The Flyway URL will look like this: <code>jdbc:mysql://awesome.url:3306/myDatabase?autoReconnect=true&amp;useSSL=true</code>. We can deploy it!</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":1887} --></p>
<figure class="wp-block-image"><img src="{{ site.baseurl }}/assets/screenshot-2019-01-13-at-12.24.33.jpg" alt="" class="wp-image-1887" /><br />
<figcaption>After enabling the SSL in the connection. Failed again...</figcaption>
</figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>Hmmm... That is strange. Let's take a step back. If I'm using SSL, it needs to use a certificate. But the container is not aware of it. Time to use the Google skills, and looking for the documentation on how to connect to a MySQL RDS instance using SSL. AWS provides <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_MySQL.html#MySQL.Concepts.SSLSupport">it</a>. They have a certificate that can be used to authenticate with the service.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>The Docker image needs to have the certificate, and given that the CLI is based on Java, we can add the certificate to the certificate store using the <code>keytool</code> CLI. The updated Dockerfile looks like:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:code --></p>
<pre class="wp-block-code"><code>FROM boxfuse/flyway:5.2.4-alpine
LABEL maintainers="João Rosa &lt;https://joaorosa.io&gt;"

ARG STORE_PASS

ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

ADD https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem ./

RUN $JAVA_HOME/bin/keytool -keystore $JAVA_HOME/lib/security/cacerts -storepass $STORE_PASS -noprompt -trustcacerts -importcert -alias rds-combined-ca-bundle -file rds-combined-ca-bundle.pem

ENV JAVA_ARGS=-Djava.security.egd=file:/dev/../dev/urandom -Djavax.net.ssl.trustStore=$JAVA_HOME/lib/security/cacerts -Djavax.net.ssl.trustStorePassword=$STORE_PASS

ENTRYPOINT ["/usr/bin/env"]</code></pre>
<p><!-- /wp:code --></p>
<p><!-- wp:paragraph --></p>
<p>As we can see, the certificate is downloaded, and using the <code>keytool</code> it is added to the certificate store. The environment variable <code>JAVA_ARGS</code> is updated to use the certificate store.</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph {"textColor":"very-dark-gray","backgroundColor":"luminous-vivid-orange"} --></p>
<p class="has-text-color has-background has-very-dark-gray-color has-luminous-vivid-orange-background-color"><strong>NOTE:</strong> as you can see it needs a password for the certificate store. For this post, I'm using an argument for the Dockerfile, using the secure environment variables from GitLab. However, <strong>it is out of scope for this post</strong> how to rotate and manage the secrets! You can use a parameter store from a public cloud provider, or software such as Hashicorp Vault. Out there are good articles on how to do it!</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Using the new Docker image, we do another round:</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:image {"id":1891} --></p>
<figure class="wp-block-image"><img src="{{ site.baseurl }}/assets/screenshot-2019-01-13-at-12.41.49.jpg" alt="" class="wp-image-1891" /><br />
<figcaption>Database deployment using SSL</figcaption>
</figure>
<p><!-- /wp:image --></p>
<p><!-- wp:paragraph --></p>
<p>As we can see, it deploys the database using an encrypted channel. Happy days, the pipeline is a bit more secure than before. :)</p>
<p><!-- /wp:paragraph --></p>
