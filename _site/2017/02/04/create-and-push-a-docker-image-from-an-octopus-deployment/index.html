<p><a href="https://www.docker.com/">Docker</a> is one of the disruptive technologies within virtualization, allowing the different containers to run on the same machine, sharing resources, reducing the overhead. The technology allows DevOps teams to have another tool to develop, build and ship software. One use case for containers is the Microservices Architecture Pattern.</p>
<h2>Background</h2>
<p><a href="https://hub.docker.com/">DockerHub</a> is the image repository offered by Docker, where we can publish public repositories (the tech community is there) or use the private repositories feature (instead of building an infrastructure in the local environment). One of the features is the <a href="https://docs.docker.com/docker-hub/builds/">Automated Builds</a> from a GitHub or Bitbucket account. Although it is a great feature, not all software shops uses this set of technologies.</p>
<p>For a software shop using Octopus, there are already <a href="https://octopus.com/docs/deploying-applications/docker-containers">features</a> to deploy Octopus images from an Octopus Deployment. However, is not possible to create and push a Docker Image based on packages stored in Octopus. To fill this gap, I create an Octopus step template where it is possible to create and push a Docker image to DockerHub.</p>
<p>This fits is an organisation moving from a VM environment to a Container environment, but keeping the current infrastructure, e. g., using Octopus to manage the releases (including where the packages are deployed).</p>
<p>The tools used for this tutorial were:</p>
<ul>
<li><a href="https://www.visualstudio.com/">Visual Studio 2015 Community Edition</a></li>
<li><a href="https://docs.docker.com/docker-for-windows/">Docker for Windows</a></li>
<li><a href="https://octopus.com/">Octopus Deploy Community Edition</a></li>
</ul>
<h2>Visual Studio and the Docker WebApp for the tutorial</h2>
<p>Using the Visual Studio .NET Core Web Application template for this tutorial, the project was created and committed <a href="https://github.com/joaoasrosa/DockerDotnetCoreDemo">here</a>. The WebApp is the out-of-the-box web application.</p>
<h2>Continuous Integration Server</h2>
<p>You can use your preferred CI server. In your CI server will need to:</p>
<ol>
<li>Publish the Docker WebApp.NET project
<pre><code>dotnet publish WebAppDemo -c Release</code></pre>
</li>
<li>Create the NuGet package for Octopus
<pre><code>Octo.exe pack --id DockerWebAppDemo --version 1.0.0</code></pre>
</li>
<li>Upload the AWS Lambda NuGet package to Octopus Server
<pre><code>NuGet.exe push DockerWebAppDemo.1.0.0.nupkg -ApiKey myApiKey -Source https://myOctopusServer</code></pre>
</li>
</ol>
<p>These instructions are generic, and depending on your CI server technology can be done in different ways. You can take them as generic steps, and adapt to your needs.</p>
<h2>Create and Push a Docker Image Octopus step template</h2>
<p>The step template is simple and straightforward. The Powershell script:</p>
<ol>
<li>Get all the required parameters, such as the DockerHub username, password, image name, among others</li>
<li>Validate the parameters, e. g., if they have a value</li>
<li>Creates the Docker image</li>
<li>Pushes the Docker image</li>
<li>Feedback the user</li>
</ol>
<p>The step template has a prerequisite; it depends on the Docker for Windows. You need to download and install it on the machines where the step will run.</p>
<h2>Octopus Project</h2>
<p>To create the Octopus image we need to use a pivot machine with Docker for Windows installed.</p>
<p><img class=" size-full wp-image-1254 aligncenter" src="/assets/octopus-docker.png" alt="octopus-docker" width="600" height="162" /></p>
<p>We will use the Octopus out-of-the-box features to deploy the DockerWebAppDemo package to the Pivot Machine, and the new step template to create and push the Docker image to DockerHub.</p>
<p>The Octopus Project will look like:</p>
<p><img class=" size-full wp-image-1259 aligncenter" src="/assets/docker-octopus-project.png" alt="docker-octopus-project" width="1090" height="454" /></p>
<p>The first step deploys the NuGet DockerWebAppDemo package to a custom location in the Pivot Machine (with the Docker Machine role).</p>
<p>The second step creates and pushes the Docker image to DockerHub using the Dockerfile provided.</p>
<p><img class=" size-full wp-image-1266 aligncenter" src="/assets/docker-octopus-step.png" alt="docker-octopus-step" width="741" height="741" /></p>
<p>After creating a release (potentially triggered by the CI server), Octopus Server can deploy it.</p>
<p><img class="alignnone size-full wp-image-1269" src="/assets/docker-octopus-deploy.png" alt="docker-octopus-deploy" width="1372" height="902" /></p>
<p>If the step runs successfully we can check the Docker image in the repository.</p>
<p><img class="alignnone size-full wp-image-1273" src="/assets/dockerhub-image.png" alt="dockerhub-image" width="1280" height="398" /></p>
<p>Or even run it in a machine running Docker, using the following command:</p>
<pre><code>docker run -p 5000:80 -e "ASPNETCORE_URLS=http://+:80" -it --rm joaoasrosa/dockerwebappdemo</code></pre>
<p>If we access to a browser using the URL:port for the Docker container, we can see the application running.</p>
<p><img class="alignnone size-full wp-image-1280" src="/assets/docker-container-run.png" alt="docker-container-run" width="1402" height="554" /></p>
<h2>Final thoughts</h2>
<p>The step allows the creation of Docker images from an Octopus deployment, centralising and minimising the packages maintenance operations. Also, it is possible to deploy the same package to a machine or a Docker image, increasing the deployment scenarios for a DevOps team.</p>
<p>The step template is under the <a href="https://github.com/OctopusDeploy/Library">Octopus Library OSS</a>. You can fork and add new features to it, or open an issue in <a href="https://github.com/joaoasrosa/Library">my fork</a>. All suggestions are welcome.</p>
