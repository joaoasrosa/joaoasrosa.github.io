<p><a href="https://aws.amazon.com/lambda/">AWS Lambda</a> is one of the AWS Compute Services, alongside with <a href="https://aws.amazon.com/ec2/">Amazon EC2</a> or <a href="https://aws.amazon.com/ecs/">Amazon EC2 Container Service</a>. In a nutshell, AWS Lambda is the serverless offer from AWS, allowing "you run code without provisioning or managing servers"[1].</p>
<p>In the DevOps spirit, and using <a href="https://octopus.com/">Octopus</a> as the Continuous Deployment tool, I couldn't find a step template to create an AWS Lambda function. If it doesn't exist, create it and give it away!</p>
<h2>Background</h2>
<p>AWS Lambda supports a broad range of technologies, such as Java, Python or NodeJS. The new kid on the block was .NET Core, <a href="https://aws.amazon.com/blogs/compute/announcing-c-sharp-support-for-aws-lambda/">announced</a> on 1<sup>st</sup> of December 2016. It was a good announcement for Microsoft tech shops, having another tool in the toolbelt.</p>
<p>The tools used for this demo were:</p>
<ul>
<li><a href="https://www.visualstudio.com/">Visual Studio 2015 Community Edition</a></li>
<li><a href="https://aws.amazon.com/visualstudio/">AWS Toolkit for Visual Studio</a></li>
<li><a href="https://aws.amazon.com/powershell/">AWS Tools for Windows Powershell</a></li>
<li><a href="https://octopus.com/">Octopus Deploy Community Edition</a></li>
</ul>
<h2>Visual Studio and AWS Lambda Function Project</h2>
<p>Using one of the Visual Studio AWS Lambda templates for the demo, the project was created and committed <a href="https://github.com/joaoasrosa/AWSLambdaDemo">here</a>. In a nutshell, the AWS Lambda function receives an Amazon S3 event and returns the S3 object Content Type. Simple and straightforward.</p>
<h2>Continuous Integration Server</h2>
<p>You can use your preferred CI server. In your CI server will need to:</p>
<ol>
<li>Publish the AWS Lambda .NET project
<pre><code>dotnet publish AWSLambdaDemo -c Release</code></pre>
</li>
<li>Zip the published AWS Lambda .NET project</li>
<li>Create the NuGet package for Octopus
<pre><code>Octo.exe pack --id AWSLambdaDemo --version 1.0.0.0</code></pre>
</li>
<li>Upload the AWS Lambda NuGet package to Octopus Server
<pre><code>NuGet.exe push AWSLambdaDemo.1.0.0.0.nupkg -ApiKey myApiKey -Source https://myOctopusServer</code></pre>
</li>
</ol>
<p>These instructions are generic, and depending on your CI server technology can be done in different ways. You can take them as generic steps, and adapt to your needs.</p>
<h2> Create AWS Lambda function Octopus step template</h2>
<p>The step template is simple and straightforward. The Powershell script:</p>
<ol>
<li>Checks if the AWS Tools for Windows Powershell is installed</li>
<li>Get all the required parameters, such as the access keys, region, function name, among others</li>
<li>Validate the parameters, e. g., if they have a value</li>
<li>Execute the operation</li>
<li>Feedback the user</li>
</ol>
<p>The step template has a prerequisite, it depends on the AWS Tools for Windows Powershell. You need to download and install it on the machines where the step will run.</p>
<h2>Octopus Project</h2>
<p>To create the AWS Lambda function, we need to use a pivot machine. At the moment is not possible to publish it directly to AWS.</p>
<p><img class=" size-full wp-image-1149 aligncenter" src="/assets/octopus2awslambda.png" alt="octopus2awslambda" width="476" height="155" /></p>
<p>We will use the Octopus out-of-the-box features to deploy the AWSLambdaDemo package to the Pivot Machine, and the new step template to publish the function to AWS.</p>
<p>The Demo Octopus Project will look like this:</p>
<p><img class=" size-full wp-image-1153 aligncenter" src="/assets/octopus-project.png" alt="octopus-project" width="1245" height="514" /></p>
<p>The first step just deploys the upload NuGet AWSLambdaDemo package to a custom location in the Pivot Machine (with the role AWS Lambda Demo).</p>
<p>The second step creates the AWS Lambda from the deployed NuGet AWSLambdaDemo package from the custom location.</p>
<p><img class=" size-full wp-image-1158 aligncenter" src="/assets/octopus-aws-step.png" alt="octopus-aws-step" width="1138" height="912" /></p>
<p>After creating a release (potentially triggered by the CI server), Octopus Server can deploy it.</p>
<p><img class=" size-full wp-image-1163 aligncenter" src="/assets/octopus-aws-deploy.png" alt="octopus-aws-deploy" width="906" height="839" /></p>
<p>And voilá! A new AWS Lambda function is deployed!</p>
<p><img class=" size-full wp-image-1167 aligncenter" src="/assets/aws-lambda.png" alt="aws-lambda" width="934" height="255" /></p>
<h2>Final thoughts</h2>
<p>The step template is under the <a href="https://github.com/OctopusDeploy/Library">Octopus Library OSS</a>. You can fork and add new features to it, or open an issue in <a href="https://github.com/joaoasrosa/Library">my fork</a>. All suggestions are welcome.</p>
<p>&nbsp;</p>
<p>[1] - <a href="http://docs.aws.amazon.com/lambda/latest/dg/welcome.html">http://docs.aws.amazon.com/lambda/latest/dg/welcome.html</a></p>
